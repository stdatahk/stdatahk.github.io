<html>
<head>
<title>Convert VR360 Photos</title>
</head>
<body style="font-family:Arial;">
<form>
Image Location: <input name='ImgUrl' id='ImgUrl' type='text' size=80 value='https://stdatahk.com/vr/dualfisheye.jpg'><br>
Pls Save File As: <input name='ImgName' id='ImgName' type='text' size=15><br>
<input type=button value=" SHOW " onClick="document.theImg.src=document.forms[0].ImgUrl.value;">&nbsp;&nbsp;&nbsp;&nbsp;	
<input type=button onclick="doRotate();" value=" FLIP/ROTATE ">&nbsp;&nbsp;&nbsp;&nbsp;
<button onclick="DownloadCanvasAsImage()"> DOWNLOAD </button>

<br><br>Preview:<br>
<img name='theImg' id='theImg' src="https://stdatahk.com/vr/dualfisheye.jpg">
<hr>              

<p>Canvas:</p>
<canvas id="theCanvas" width="1" height="1" style="border:1px solid #d3d3d3;"></canvas>

<script>
if(location.href.indexOf('?')>0) {
	url = location.href.substring(location.href.indexOf('?')+1);
	url = decodeURIComponent(url);
	document.getElementById('ImgUrl').value = url;
	document.getElementById('theImg').src = url;

	fname = location.href.substring(location.href.lastIndexOf('%2F')+3);
	fname = decodeURI(fname);
	fname = fname.substring(0, fname.lastIndexOf('.')) + '.png';
	fname = fname.split(" ").join("_");
	document.getElementById('ImgName').value = fname;
	
}
	
function doRotate() {
  var c = document.getElementById("theCanvas");
  var ctx = c.getContext("2d");
  var img = document.getElementById("theImg");
  c.width = img.width;
  c.height = img.height;

  ctx.drawImage(img,0,0);  
  ctx.drawImage(img, img.width/2,0,img.width,img.height, 0,0,img.width/2,img.height);  

  ctx.translate(c.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(img, 2160, 0); //hardcode
    
  //drawRotated(c,ctx,180,img, 0,0,img.width/2,img.height, 0,0,img.width/2,img.height);
  img.height = Math.round(img.height*300/img.width);
  img.width = 300;
}
  
function drawRotated(canvas, context, degrees, image, sx,sy,sw,sh,dx,dy,dw,dh){
    //context.clearRect(0,0,canvas.width,canvas.height);
    context.save();
    context.translate(canvas.width/2,canvas.height/2);
    context.rotate(degrees*Math.PI/180);
    context.translate(-canvas.width/2,-canvas.height/2);
    context.drawImage(image,sx,sy,sw,sh,dx+2160,dy,dw,dh); //hardcode
    context.restore();
}

function DownloadCanvasAsImage() {
	var fname = 'Image.png';
	if(location.href.indexOf('?')>0) {
		fname = location.href.substring(location.href.lastIndexOf('%2F')+3);
		fname = decodeURI(fname);
		fname = fname.substring(0, fname.lastIndexOf('.')) + '.png';
		fname = fname.split(" ").join("_");
		fname = 'Image.png';
	}	
		alert(fname);
	let downloadLink = document.createElement('a');
	downloadLink.setAttribute('download', fname);
	let canvas = document.getElementById('theCanvas');
	let dataURL = canvas.toDataURL('image/png');
	let dUrl = dataURL.replace(/^data:image\/png/,'data:application/octet-stream');
	downloadLink.setAttribute('href', dUrl);
	downloadLink.click();
}  
</script>
              
</form>
</body>
</html>
