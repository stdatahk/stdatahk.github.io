<html>
<head>
<title>FRS | Admin| Defect List</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>

<img src="logo.png">
<br>

<h2 style="font-family:Arial;">FRS - FULL DEFECT LIST:</h2>

<div id="theDiv" style="text-align:right;">
<input style="width:80px;height:30px;" type=button value="REFRESH" onclick="location.reload();">
&nbsp;&nbsp;
<input style="width:70px;height:30px;" type=button value="EDIT" onclick="location.href='wip.htm';">
&nbsp;&nbsp;
<input style="width:70px;height:30px;" type=button value="DELETE"onclick="location.href='defect_del.htm';">
</div>
<br>

<b>篩選條件：</b>
BY 
<select id="sel1" onchange='filterSel1();'>
	<option id='sel1op0'>載入中...</option>
</select>
OR 
<select id="sel2" onchange='filterSel2();'>
	<option id='sel2op0'>載入中...</option>
</select>
OR 
<select id="sel3">
	<option id='sel3op0'>驗樓師</option>
	<option>admin</option>
	<option>guest001</option>
	<option>guest002</option>
	<option>guest003</option>
</select>
<br><br>

<table id='tbl' width='100%' border=1 cellpadding=2 cellspacing=0 style="font-family:Arial;">
<!-- table header -->
<tr>
<td style="font-weight:bold;font-size:20px;">
	Defect ID
</td>
<td style="font-weight:bold;font-size:20px;">
	QR Code
</td>
<td style="font-weight:bold;font-size:20px;">
	Defect Photo
</td>
<td style="font-weight:bold;font-size:20px;">
	Defect(x,y)
</td>
<td style="font-weight:bold;font-size:20px;">
	單位平面圖
</td>
<td style="font-weight:bold;font-size:20px;">
	平面圖(x,y)
</td>
<td style="font-weight:bold;font-size:20px;">
	樓盤／大廈
</td>
<td style="font-weight:bold;font-size:20px;">
	座數／樓層／單位
</td>
<td style="font-weight:bold;font-size:20px;">
	位置
</td>
<td style="font-weight:bold;font-size:20px;">
	工種
</td>
<td style="font-weight:bold;font-size:20px;">
	詳細項目
</td>
<td style="font-weight:bold;font-size:20px;">
	驗樓師 User ID
</td>



</tr>
<!-- end table header -->
<tr id='tr0'>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
<td>Loading...</td>
</tr>
</table>


<script language="JavaScript">
<!--
var gasId = "AKfycbwHLSiDw3M30YfAjThHfy0a7BEbzcbho_YPpPXAFAVFD5pWnvg_";
var gasUrl = "https://script.google.com/macros/s/"+ gasId +"/exec";
var gssId = "14kr-iLsi2Ubot0wq8xHiH5ST-KYIzF5KCsl8AW8hJDk" //for defects list 
var gssId1 = "14kr-iLsi2Ubot0wq8xHiH5ST-KYIzF5KCsl8AW8hJDk" //for defects list 
var gssId2 = "1UIXxABQINMOZkIbErvviFQDIDDlAdjTo7hk3GFqzq70"; //for bldg db

//render data table content
$(document).ready(function(){
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETDATA', 
		id: gssId,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
	  
		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);


		if(ary.length > 0) {
			$("#tr0").remove();
			$("#tbl").prepend("共 "+ ary.length +" 筆資料");
		}

		for(var i=0; i<ary.length; i++) {
			var obj = JSON.parse(ary[i][1]);
		
			rst += "<tr id='tr"+ i +"'>";
			rst += "<td>"+ ary[i][0] +"</td>";
			rst += "<td><a target='_blank' href='qr_gen.htm#"+ ary[i][0] +"'><img height=50 src='qr/qr1.png'></a></td>";
			rst += "<td><a target='_blank' href='"+ obj.url +"'><img height=50 src='"+ obj.url +"'></a></td>";
			rst += "<td>("+ obj.dpX +","+ obj.dpY +")</td>";
			rst += "<td><a target='_blank' href='"+ obj.fp +"'><img height=50 src='"+ obj.fp +"'></a></td>";
			rst += "<td>("+ obj.fpX +","+ obj.fpY +")</td>";
			rst += "<td>"+ obj.bldg +"</td>";
			rst += "<td>"+ obj.addr +"</td>";
			rst += "<td>"+ obj.di +"</td>";
			rst += "<td>"+ obj.tx +"</td>";
			rst += "<td>"+ obj.dd +"</td>";
			rst += "<td>guest001</td>";
			rst += "</tr>";
		}
		$("#tbl").append(rst);
	  }
	});

});


//populate pull-down menus
$(document).ready(function(){
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETTAGS', 
		id: gssId1,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
		//process query string param (if any)
		var url = location.href;
		var pos = url.lastIndexOf('#?');
		var params = '';
		if(pos > 0)	params = url.substring(pos+2);

		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);

		if(ary.length > 0) {
			$("#sel1op0").remove();
			$("#sel1").append("<option value=''>Defect ID</option>");
		}

		for(var i=0; i<ary.length; i++) {
			if(params!='' && params==ary[i])
				rst += "<option value='"+ ary[i] +"' SELECTED>"+ ary[i] +"</option>";
			else
				rst += "<option value='"+ ary[i] +"'>"+ ary[i] +"</option>";
		}
		$("#sel1").append(rst);
	  }
	});
});

$(document).ready(function(){
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETTAGS', 
		id: gssId2,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
	  
		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);

		if(ary.length > 0) {
			$("#sel2op0").remove();
			$("#sel2").append("<option value=''>樓盤／大廈</option>");
		}

		for(var i=0; i<ary.length; i++) {
			rst += "<option value='"+ ary[i] +"'>"+ ary[i] +"</option>";
		}
		$("#sel2").append(rst);
	  }
	});
});

//client-side filtering (quick & dirty method)
function filterSel1() {
	var theSel = document.getElementById('sel1');
	var idx = -1;
	for(var i=0; i < theSel.options.length; i++) {
		if(theSel.options[i].selected) {
			idx = i;
			break;
		}
	}
	//remove unwanted tr items
	idx = idx - 1; //tbl hdr
	var rst = '';
	for(var i=0; i < theSel.options.length-1; i++) {
			if(i!=idx)
				rst += ('_#tr'+i);
	}
	var a = rst.substring(1).split('_');
	for(var i=0; i < a.length; i++) {
		$(a[i]).remove();
	}
}

function filterSel2() {
	var theSel = document.getElementById('sel2');
	var idx = "";
	for(var i=0; i < theSel.options.length; i++) {
		if(theSel.options[i].selected) {
			idx = theSel.options[i].value;
			break;
		}
	}
	//remove unwanted tr items
	var rst = '';
	var theSel1 = document.getElementById('sel2');
	for(var i=0; i < theSel1.options.length-1; i++) {
		var theTr = ('tr'+i);
		if(!document.getElementById(theTr)) continue;
		var txt = document.getElementById(theTr).childNodes[6].innerHTML; //6th-col
		if(txt != idx)
			rst += ('_#tr'+i);
	}
	var a = rst.substring(1).split('_');
	for(var i=0; i < a.length; i++) {
		$(a[i]).remove();
	}
}
//-->
</script>

<br><br>
<div id="theDiv" style="text-align:right;">
<input style="width:130px;height:30px;" type=button value="返回" onclick="location.href='admin.htm';">
</div>

</body>
</html>
