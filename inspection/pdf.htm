<html>
<head>
<title>FRS | Admin| Report</title>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://stdatahk-fast-reporting-system-pdf.on.drv.tw/fps_pdf/SimHei-normal.js"></script>
<script src="https://stdatahk.com/inspection/districts.js"></script>
</head>
<body>

<h2>Report Generation</h2>

<div id="theDiv" style="text-align:right;">
<input style="width:130px;height:30px;" type=button value="返回" onclick="location.href='https://stdatahk.com/inspection/admin.htm';">
</div>
<hr>
<br>

<b>篩選條件：</b>
BY 
<select id="sel1" onchange='filterSel1();'>
	<option id='sel1op0'>載入中...</option>
</select>
OR 
<select id="sel2">
	<option id='sel2op0'>載入中...</option>
</select>
<select id="sel3" DISABLED>
	<option id='sel3op0'>載入中...</option>
</select>
<select id="sel4" DISABLED onchange='filterSel4();'>
	<option id='sel4op0'>載入中...</option>
</select>
<br><br>

<input id="btnPdf" type=button value="生成 PDF 報告" 
 style="width:150px;height:50px;">
&nbsp;&nbsp;
<input id="btnJpg" type=button value="生成 PNG 圖像" 
 style="width:150px;height:50px;"  onclick='location.href="png.htm";'>

<br><br>
<br><br>
一個比較官方正式，方便公司間電郵通訊用。<br>
另一個比較簡淺易明，方便在中傳送。


<br><br>

<script type="text/javascript">
<!--
var gasId = "AKfycbwHLSiDw3M30YfAjThHfy0a7BEbzcbho_YPpPXAFAVFD5pWnvg_";
var gasUrl = "https://script.google.com/macros/s/"+ gasId +"/exec";
var gssId = "14kr-iLsi2Ubot0wq8xHiH5ST-KYIzF5KCsl8AW8hJDk" //for defects list 
var gssId1 = "14kr-iLsi2Ubot0wq8xHiH5ST-KYIzF5KCsl8AW8hJDk" //for defects list 
var gssId2 = "1UIXxABQINMOZkIbErvviFQDIDDlAdjTo7hk3GFqzq70"; //for bldg db

//populate pull-down menu (Defect ID list)
$(document).ready(function(){
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETTAGS', 
		id: gssId1,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
		//process query string param (if any)
		var url = location.href;
		var pos = url.lastIndexOf('#?');
		var params = '';
		if(pos > 0)	params = url.substring(pos+2);

		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);

		if(ary.length > 0) {
			$("#sel1op0").remove();
			$("#sel1").append("<option value=''>Defect ID</option>");
		}

		for(var i=0; i<ary.length; i++) {
			if(params!='' && params==ary[i])
				rst += "<option value='"+ ary[i] +"' SELECTED>"+ ary[i] +"</option>";
			else
				rst += "<option value='"+ ary[i] +"'>"+ ary[i] +"</option>";
		}
		$("#sel1").append(rst);
	  }
	});
});


$(document).ready(function(){
	$("#sel2op0").remove();
	$("#sel2").append("<option value=''>地區</option>");
	var rst = "";
	for(var i=0; i < D18.length; i++) {
		if(i>0 && D18[i][0]==D18[i-1][0]) continue;
		rst += "<option value='"+ D18[i][0] +"'>"+ D18[i][0] +"</option>";
	}
	$("#sel2").append(rst);
});
	
$("#sel2").change(function(){
	document.getElementById('sel3').disabled = false;
	$("#sel3").find('option:not(:first)').remove();
	if($("#sel3op0").length) {
		$("#sel3op0").remove();
		$("#sel3").append("<option value=''>分區</option>");
	}
	var rst = "";
	for(var i=0; i < D18.length; i++) {
		if($("#sel2").val()!=D18[i][0])
			continue;
		rst += "<option value='"+ D18[i][1] +"'>"+ D18[i][1] +"</option>";
	}
	$("#sel3").append(rst);
});

$("#sel3").change(function(){
	document.getElementById('sel4').disabled = false;
	$("#sel4").find('option:not(:first)').remove();
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETDATA', 
		id: gssId2,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
  		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);

		if(ary.length > 0) {
			$("#sel4op0").remove();
			$("#sel4").append("<option value=''>樓盤／大廈</option>");
		}

		for(var i=0; i<ary.length; i++) {
			if(ary[i][1] != $("#sel3 option:selected").text()) continue;
			rst += "<option value='"+ ary[i][0] +"'>"+ ary[i][0] +"</option>";
		}
		$("#sel4").append(rst);
	  }
	});
});


$("#btnPdf").click(function(){
	$("#btnPdf").val('PDF生成中，請稍等...');

	//getting data from DB
	$.ajax({
	  url: gasUrl,
	  cache: false,
	  type: "GET",
	  data: {
		func: 'GETDATA', 
		id: gssId,  
		key: 12345678
	  },
	  dataType: "html",
	  success: function(html){
	  
		var ary = null;
		var rst = "";
		html = "ary="+html+";";
	    eval(html);

		//PDF generation
		window.jsPDF = window.jspdf.jsPDF;
		var doc = new jsPDF('landscape')
		
		//adding chinese font
		doc.addFileToVFS('SimHei-normal.ttf', font);
		doc.addFont('SimHei-normal.ttf', 'SimHei', 'normal')
		doc.setFont('SimHei');

		//doc.addFont('https://stdatahk-fast-reporting-system-pdf.on.drv.tw/fps_pdf/SimHei.ttf', 'SimHei', 'normal');
		//doc.setFont('SimHei');
		//doc.addFont("msjh.ttc", "Microsoft JhengHei", "Regular"); //Regular
		//doc.setFont("JhengHei", "Regular"); // set font
		//doc.setFontSize(20);

		var theSel1 = document.getElementById('sel1');
		var theSel4 = document.getElementById('sel4');
		var isSelected1 = true;
		var isSelected2 = true;
		if(!theSel1.options[0].selected) isSelected1 = false;
		if(!theSel4.options[0].selected) isSelected2 = false;
		
		var isFirst = true;
		for(var i=0; i<ary.length; i++) {
			var obj = JSON.parse(ary[i][1]);

			if(!document.getElementById('sel1').options[0].selected) {
				if($("#sel1 option:selected").text() != ary[i][0]) 
					continue; //skip for defect id
			}
			if(!document.getElementById('sel4').options[0].selected) {
				if($("#sel4 option:selected").text() != obj.bldg) 
					continue; //skip for bldg name
			}
		
			if(isFirst) { //do cover page
				doc.setFontSize(32);
				doc.text("Defect Report", 110, 105);
				//footer line
				doc.rect(40, 160, 245, 0);
				doc.setFontSize(13);
				doc.text("Defects Report", 40, 158);

				var date = new Date();
				var ddmmyyyy = ( date.getFullYear().toString() +'/'+ pad2(date.getMonth() + 1) +'/'+ pad2( date.getDate()) );
				doc.text(ddmmyyyy, 40, 165);
				
				doc.setFontSize(13);
				isFirst = false;
			}
			doc.addPage(); //new page

			//defect photo area
			doc.rect(10, 15, 200, 125);
			//LHS lower text info area
			doc.rect(10, 140, 200, 60);
			doc.rect(50, 140, 0, 60); //vert line
			doc.rect(10, 150, 200, 0); //horz line
			doc.rect(10, 160, 200, 0); //horz line
			doc.rect(10, 170, 200, 0); //horz line
			doc.rect(10, 180, 200, 0); //horz line
			doc.rect(10, 190, 200, 0); //horz line
			//RHS lower text info area
			var sx=215; var sy=95; //start xy
			var ex=290; var ey=200 ; //end xy
			var h = Math.floor((ey-sy)/13);
			doc.rect(sx,    sy, ex-sx, ey-sy);
			doc.rect(sx+25, sy, 0, ey-sy); //vert line
			doc.rect(sx,    sy+h*1, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*2, ex-sx-25, 0); //horz line
			doc.rect(sx,    sy+h*3, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*4, ex-sx-25, 0); //horz line
			doc.rect(sx,    sy+h*5, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*6, ex-sx-25, 0); //horz line
			doc.rect(sx,    sy+h*7, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*8, ex-sx-25, 0); //horz line
			doc.rect(sx,    sy+h*9, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*10, ex-sx-25, 0); //horz line
			doc.rect(sx,    sy+h*11, ex-sx, 0); //horz line
			doc.rect(sx+25, sy+h*12, ex-sx-25, 0); //horz line

			doc.text("Item No.",                               12, 146);
			doc.text("Date of Record",                         12, 156);
			doc.text("Location/Floor/House",                   12, 166);
			doc.text("Defects were Rectified by",              12, 176);
			doc.text("Defects as Identified By Representtive", 12, 186);
			doc.text("Others",                                 12, 196);
			

			//pic - defect pic
			var img = new Image();
			img.src = obj.url;
			doc.addImage(img, 'png', 40, 20, 100, 100);
			//pic 2 - floorplan
			var img = new Image();
			//img.src = 'floorplan.png';
			img.src = obj.fp;
			doc.addImage(img, 'png', 220, 15, 50, 80);
			//pic 3 - logo
			//var img = new Image();
			//img.src = 'logo.png';
			//doc.addImage(img, 'png', 259, 147, 20, 20);
			//pic 4 - QR
			//var img = new Image();
			//img.src = 'qr/qr1.png';
			//doc.addImage(img, 'png', 251, 169, 30, 30);

			doc.text("FRS - Site Inspection Report (Defect ID: "+ ary[i][0] +")", 10, 10);
			//doc.text("[[[ HD Photo Here ]]]\n   (with markings)", 40, 40);
			//doc.text("[[[ Floorplan Here ]]]\n   (with overlay)", 210, 60);
			//doc.text("[[[ Company Logo Here ]]]", 220, 150);
			//doc.text("[[[ QR Here ]]]", 240, 190);
			doc.text(obj.bldg, 55, 155);
			doc.text(obj.addr, 55, 165);
			doc.text(obj.di+ obj.tx + obj.dd, 55, 175);
		}
		
		//generate timestamp for filename
		var date = new Date();
		var ts = ( date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2( date.getDate()) +'_'+ pad2( date.getHours() ) + pad2( date.getMinutes() ) + pad2( date.getSeconds() ) );
		doc.save("P"+ts+".pdf");
	  }
	});
});

function pad2(n) { return n < 10 ? '0' + n : n }
//-->
</script>

<script src="https://www.drv.tw/inc/wd.js?s=stdatahk-fast-reporting-system-pdf"></script></body>
</html>
